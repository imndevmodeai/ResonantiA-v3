{"content": "TERM: Function: append_fact\n\nDEFINITION:\nFunction: append_fact\n\nAppend an atomic fact into facts_ledger with timestamp.\n\nParameters: state, fact\n\nBLUEPRINT DETAILS:\nExtracted from /mnt/3626C55326C514B1/Happier/Three_PointO_ArchE/session_state_manager.py, type: python_function\n\nFULL IMPLEMENTATION CODE (session_state_manager.py):\n```python\nimport json\nimport os\nfrom datetime import datetime\n\n# ============================================================================\n# TEMPORAL CORE INTEGRATION (CANONICAL DATETIME SYSTEM)\n# ============================================================================\nfrom .temporal_core import now_iso, format_filename, format_log, Timer\nfrom pathlib import Path\nfrom typing import Dict, Any\n\ntry:\n    from .config import get_config\nexcept Exception:  # pragma: no cover - fallback for standalone\n    def get_config():\n        class _P:\n            class paths:\n                project_root = Path(os.getcwd())\n        return _P()\n\n\ndef _state_path() -> Path:\n    cfg = get_config()\n    return Path(getattr(cfg.paths, \"project_root\", Path(os.getcwd()))) / \"session_state.json\"\n\n\ndef load_session_state() -> Dict[str, Any]:\n    \"\"\"Load session_state.json, ensuring required keys exist.\"\"\"\n    path = _state_path()\n    if not path.exists():\n        return {\"facts_ledger\": [], \"updated_at\": now_iso() + \"Z\"}\n    try:\n        with open(path, \"r\", encoding=\"utf-8\") as f:\n            data = json.load(f)\n    except Exception:\n        data = {}\n    if not isinstance(data, dict):\n        data = {}\n    data.setdefault(\"facts_ledger\", [])\n    data[\"updated_at\"] = now_iso() + \"Z\"\n    return data\n\n\ndef save_session_state(state: Dict[str, Any]) -> None:\n    \"\"\"Persist the provided state to session_state.json safely.\"\"\"\n    path = _state_path()\n    try:\n        path.parent.mkdir(parents=True, exist_ok=True)\n        tmp = path.with_suffix(\".tmp\")\n        with open(tmp, \"w\", encoding=\"utf-8\") as f:\n            json.dump(state, f, ensure_ascii=False, indent=2)\n        os.replace(tmp, path)\n    except Exception:\n        # Best-effort persistence; do not throw inside engine\n        pass\n\n\ndef append_fact(state: Dict[str, Any], fact: Dict[str, Any]) -> None:\n    \"\"\"Append an atomic fact into facts_ledger with timestamp.\"\"\"\n    if not isinstance(state.get(\"facts_ledger\"), list):\n        state[\"facts_ledger\"] = []\n    entry = {**fact}\n    entry.setdefault(\"ts\", now_iso() + \"Z\")\n    state[\"facts_ledger\"].append(entry)\n    state[\"updated_at\"] = now_iso() + \"Z\"\n\n\n\n```\n\nEXAMPLE APPLICATION:\nFunction: append_fact\n\nAppend an atomic fact into facts_ledger with timestamp.\n\nParameters: state, fact\n\nCATEGORY: CodeKnowledge\n\nRELATIONSHIPS:\ntype: FromCodebase; source: /mnt/3626C55326C514B1/Happier/Three_PointO_ArchE/session_state_manager.py; source_type: python_function"}