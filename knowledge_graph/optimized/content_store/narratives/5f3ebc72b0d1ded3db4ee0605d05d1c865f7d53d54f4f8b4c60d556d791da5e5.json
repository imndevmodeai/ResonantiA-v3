{"content": "TERM: Class: SessionAutoCapture\n\nDEFINITION:\nClass: SessionAutoCapture\n\nAutomatically captures conversation sessions and exports them to markdown.\n\nIntegrates with:\n- session_manager.py for session tracking\n- thought_trail.py for IAR entries\n- Autopoietic learning loop for pattern detection\n\nMethods: __init__, capture_message, capture_iar_entry, capture_spr_priming, capture_insight, export_session, _generate_markdown, reset_session, get_session_summary\n\nBLUEPRINT DETAILS:\nExtracted from /mnt/3626C55326C514B1/Happier/Three_PointO_ArchE/session_auto_capture.py, type: python_class\n\nFULL IMPLEMENTATION CODE (session_auto_capture.py):\n```python\n\"\"\"\nSession Auto-Capture System\n============================\n\nAutomatically captures and exports conversation sessions to markdown files,\nintegrating with the existing session_manager.py and ThoughtTrail system.\n\nThis closes the gap between manual cursor_*.md file creation and automated\nsession persistence.\n\"\"\"\n\nimport json\nimport logging\nfrom pathlib import Path\nfrom typing import Dict, Any, List, Optional\nfrom datetime import datetime\n\n# ============================================================================\n# TEMPORAL CORE INTEGRATION (CANONICAL DATETIME SYSTEM)\n# ============================================================================\nfrom Three_PointO_ArchE.temporal_core import now_iso\nfrom Three_PointO_ArchE.thought_trail import log_to_thought_trail\n\nlogger = logging.getLogger(__name__)\n\nclass SessionAutoCapture:\n    \"\"\"\n    Automatically captures conversation sessions and exports them to markdown.\n    \n    Integrates with:\n    - session_manager.py for session tracking\n    - thought_trail.py for IAR entries\n    - Autopoietic learning loop for pattern detection\n    \"\"\"\n    \n    def __init__(self, \n                 output_dir: str = \".\",\n                 session_manager=None,\n                 thought_trail=None):\n        \"\"\"\n        Initialize the auto-capture system.\n        \n        Args:\n            output_dir: Directory to save captured sessions\n            session_manager: Existing SessionManager instance\n            thought_trail: Existing ThoughtTrail instance\n        \"\"\"\n        self.output_dir = Path(output_dir)\n        self.output_dir.mkdir(parents=True, exist_ok=True)\n        self.session_manager = session_manager\n        self.thought_trail = thought_trail\n        self.current_session_data = {\n            \"messages\": [],\n            \"iar_entries\": [],\n            \"sprs_primed\": [],\n            \"insights_detected\": []\n        }\n        \n        logger.info(f\"SessionAutoCapture initialized, output to: {self.output_dir}\")\n    \n    @log_to_thought_trail\n    def capture_message(self, role: str, content: str, metadata: Dict[str, Any] = None):\n        \"\"\"\n        Capture a single message in the conversation.\n        \n        Args:\n            role: 'user' or 'assistant'\n            content: Message content\n            metadata: Optional metadata (timestamp, confidence, etc.)\n        \"\"\"\n        message = {\n            \"role\": role,\n            \"content\": content,\n            \"timestamp\": now_iso(),\n            \"metadata\": metadata or {}\n        }\n        \n        self.current_session_data[\"messages\"].append(message)\n        logger.debug(f\"Captured {role} message ({len(content)} chars)\")\n    \n    @log_to_thought_trail\n    def capture_iar_entry(self, iar_entry: Dict[str, Any]):\n        \"\"\"\n        Capture an IAR entry from ThoughtTrail.\n        \n        Args:\n            iar_entry: IAR entry dictionary\n        \"\"\"\n        self.current_session_data[\"iar_entries\"].append(iar_entry)\n        logger.debug(f\"Captured IAR entry: {iar_entry.get('task_id', 'unknown')}\")\n    \n    @log_to_thought_trail\n    def capture_spr_priming(self, sprs: List[Dict[str, Any]]):\n        \"\"\"\n        Capture SPRs that were primed during the session.\n        \n        Args:\n            sprs: List of primed SPR dictionaries\n        \"\"\"\n        self.current_session_data[\"sprs_primed\"].extend(sprs)\n        logger.debug(f\"Captured {len(sprs)} primed SPRs\")\n    \n    @log_to_thought_trail\n    def capture_insight(self, insight: Dict[str, Any]):\n        \"\"\"\n        Capture an insight detected by the learning loop.\n        \n        Args:\n            insight: Insight dictionary\n        \"\"\"\n        self.current_session_data[\"insights_detected\"].append(insight)\n        logger.debug(f\"Captured insight: {insight.get('core_concept', 'unknown')}\")\n    \n    @log_to_thought_trail\n    def export_session(self, session_id: str = None, topic: str = None) -> Path:\n        \"\"\"\n        Export the current session to a markdown file.\n        \n        Args:\n            session_id: Optional session identifier\n            topic: Optional topic/title for the session\n            \n        Returns:\n            Path to the exported markdown file\n        \"\"\"\n        timestamp = datetime.now().strftime(\"%m.%d.%y\")\n        \n        # Generate filename following existing pattern\n        if topic:\n            safe_topic = topic.lower().replace(\" \", \"_\")[:50]\n            filename = f\"cursor_{safe_topic}.{timestamp}.md\"\n        else:\n            filename = f\"cursor_session_{session_id or 'unknown'}.{timestamp}.md\"\n        \n        filepath = self.output_dir / filename\n        \n        # Generate markdown content\n        content = self._generate_markdown()\n        \n        # Write to file\n        filepath.write_text(content, encoding='utf-8')\n        logger.info(f\"Session exported to: {filepath}\")\n        \n        return filepath\n    \n    def _generate_markdown(self) -> str:\n        \"\"\"\n        Generate markdown content from captured session data.\n        \n        Returns:\n            Markdown formatted string\n        \"\"\"\n        lines = []\n        \n        # Header\n        lines.append(f\"# ArchE Session Capture\")\n        lines.append(f\"_Auto-exported on {now_iso()} from ArchE SessionAutoCapture_\")\n        lines.append(\"\")\n        lines.append(\"---\")\n        lines.append(\"\")\n        \n        # Session Summary\n        lines.append(\"## Session Summary\")\n        lines.append(\"\")\n        lines.append(f\"- **Messages**: {len(self.current_session_data['messages'])}\")\n        lines.append(f\"- **IAR Entries**: {len(self.current_session_data['iar_entries'])}\")\n        lines.append(f\"- **SPRs Primed**: {len(self.current_session_data['sprs_primed'])}\")\n        lines.append(f\"- **Insights Detected**: {len(self.current_session_data['insights_detected'])}\")\n        lines.append(\"\")\n        lines.append(\"---\")\n        lines.append(\"\")\n        \n        # Conversation\n        lines.append(\"## Conversation\")\n        lines.append(\"\")\n        \n        for msg in self.current_session_data[\"messages\"]:\n            role = msg[\"role\"].title()\n            content = msg[\"content\"]\n            \n            lines.append(f\"**{role}**\")\n            lines.append(\"\")\n            lines.append(content)\n            lines.append(\"\")\n            lines.append(\"---\")\n            lines.append(\"\")\n        \n        # SPRs Primed\n        if self.current_session_data[\"sprs_primed\"]:\n            lines.append(\"## SPRs Activated During Session\")\n            lines.append(\"\")\n            \n            unique_sprs = {}\n            for spr in self.current_session_data[\"sprs_primed\"]:\n                spr_id = spr.get(\"spr_id\", \"unknown\")\n                if spr_id not in unique_sprs:\n                    unique_sprs[spr_id] = spr\n            \n            for spr_id, spr_data in unique_sprs.items():\n                lines.append(f\"### `{spr_id}`\")\n                definition = spr_data.get(\"definition\", \"No definition available\")\n                lines.append(f\"{definition}\")\n                lines.append(\"\")\n            \n            lines.append(\"---\")\n            lines.append(\"\")\n        \n        # IAR Entries\n        if self.current_session_data[\"iar_entries\"]:\n            lines.append(\"## IAR Reflection Log\")\n            lines.append(\"\")\n            \n            for iar in self.current_session_data[\"iar_entries\"]:\n                task_id = iar.get(\"task_id\", \"unknown\")\n                action = iar.get(\"action_type\", \"unknown\")\n                confidence = iar.get(\"confidence\", 0.0)\n                \n                lines.append(f\"### Action: `{action}` (ID: {task_id})\")\n                lines.append(f\"**Confidence**: {confidence:.2f}\")\n                lines.append(\"\")\n                \n                iar_dict = iar.get(\"iar\", {})\n                if iar_dict:\n                    lines.append(f\"**Intention**: {iar_dict.get('intention', 'N/A')}\")\n                    lines.append(f\"**Action**: {iar_dict.get('action', 'N/A')}\")\n                    lines.append(f\"**Reflection**: {iar_dict.get('reflection', 'N/A')}\")\n                    lines.append(\"\")\n            \n            lines.append(\"---\")\n            lines.append(\"\")\n        \n        # Insights\n        if self.current_session_data[\"insights_detected\"]:\n            lines.append(\"## Insights Detected by Autopoietic Learning Loop\")\n            lines.append(\"\")\n            \n            for insight in self.current_session_data[\"insights_detected\"]:\n                concept = insight.get(\"core_concept\", \"Unknown Concept\")\n                confidence = insight.get(\"confidence\", 0.0)\n                \n                lines.append(f\"### Insight: {concept}\")\n                lines.append(f\"**Confidence**: {confidence:.2f}\")\n                lines.append(\"\")\n                lines.append(insight.get(\"supporting_details\", \"No details available\"))\n                lines.append(\"\")\n            \n            lines.append(\"---\")\n            lines.append(\"\")\n        \n        # Footer\n        lines.append(\"## Session Metadata\")\n        lines.append(\"\")\n        lines.append(\"```json\")\n        metadata = {\n            \"exported_at\": now_iso(),\n            \"message_count\": len(self.current_session_data[\"messages\"]),\n            \"iar_count\": len(self.current_session_data[\"iar_entries\"]),\n            \"spr_count\": len(set(s.get(\"spr_id\") for s in self.current_session_data[\"sprs_primed\"])),\n            \"insight_count\": len(self.current_session_data[\"insights_detected\"])\n        }\n        lines.append(json.dumps(metadata, indent=2))\n        lines.append(\"```\")\n        lines.append(\"\")\n        lines.append(\"---\")\n        lines.append(\"\")\n        lines.append(\"*This session was automatically captured and exported by ArchE SessionAutoCapture system.*\")\n        \n        return \"\\n\".join(lines)\n    \n    @log_to_thought_trail\n    def reset_session(self):\n        \"\"\"Reset session data for a new session.\"\"\"\n        self.current_session_data = {\n            \"messages\": [],\n            \"iar_entries\": [],\n            \"sprs_primed\": [],\n            \"insights_detected\": []\n        }\n        logger.info(\"Session data reset for new session\")\n    \n    @log_to_thought_trail\n    def get_session_summary(self) -> Dict[str, Any]:\n        \"\"\"\n        Get a summary of the current session data.\n        \n        Returns:\n            Dictionary with session statistics\n        \"\"\"\n        return {\n            \"message_count\": len(self.current_session_data[\"messages\"]),\n            \"iar_count\": len(self.current_session_data[\"iar_entries\"]),\n            \"unique_sprs\": len(set(s.get(\"spr_id\") for s in self.current_session_data[\"sprs_primed\"])),\n            \"insight_count\": len(self.current_session_data[\"insights_detected\"]),\n            \"last_activity\": now_iso()\n        }\n\n\n```\n\nEXAMPLE APPLICATION:\nClass: SessionAutoCapture\n\nAutomatically captures conversation sessions and exports them to markdown.\n\nIntegrates with:\n- session_manager.py for session tracking\n- thought_trail.py for IAR entries\n- Autopoietic learning loop for pattern detection\n\nMethods: __init__, capture_message, capture_iar_entry, capture_spr_priming, capture_insight, export_session, _generate_markdown, reset_session, get_session_summary\n\nCATEGORY: CodeKnowledge\n\nRELATIONSHIPS:\ntype: FromCodebase; source: /mnt/3626C55326C514B1/Happier/Three_PointO_ArchE/session_auto_capture.py; source_type: python_class"}